import asyncio
import json
from ..shared_storage import tasks, update_task_progress
from ..services.storage import save_bytes


async def simulate_processing(job_id: str):
    """–ò–º–∏—Ç–∏—Ä—É–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Ñ–∞–π–ª–∞ —Å –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å–∞"""

    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∑–∞–¥–∞—á–∏
    task_data = tasks.get(job_id)
    if not task_data:
        print(f"‚ùå –ó–∞–¥–∞—á–∞ {job_id} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –≤ —Ö—Ä–∞–Ω–∏–ª–∏—â–µ")
        return

    # –≠—Ç–∞–ø—ã –æ–±—Ä–∞–±–æ—Ç–∫–∏ —Å —Å–æ–æ–±—â–µ–Ω–∏—è–º–∏
    stages = [
        (10, "Processing audio..."),
        (25, "Speech recognition started"),
        (40, "Converting to text"),
        (60, "Structuring content"),
        (80, "Generating Markdown"),
        (100, "Task completed!")
    ]

    for progress, message in stages:
        # –ñ–¥–µ–º –ø–µ—Ä–µ–¥ —Å–ª–µ–¥—É—é—â–∏–º —ç—Ç–∞–ø–æ–º
        await asyncio.sleep(2)

        # –û–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ–≥—Ä–µ—Å—Å
        status = "processing" if progress < 100 else "completed"
        update_task_progress(job_id, progress, status, message)

        print(f"üìä Progress updated for {job_id}: {progress}% - {message}")

    # ‚≠ê‚≠ê‚≠ê –°–û–ó–î–ê–ï–ú –¢–ï–°–¢–û–í–´–ï –§–ê–ô–õ–´ –†–ï–ó–£–õ–¨–¢–ê–¢–û–í ‚≠ê‚≠ê‚≠ê
    if progress == 100:  # –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–±—Ä–∞–±–æ—Ç–∫–∏
        await create_test_results(job_id, task_data)


async def create_test_results(job_id: str, task_data: dict):
    """–°–æ–∑–¥–∞–µ—Ç —Ç–µ—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è –¥–µ–º–æ–Ω—Å—Ç—Ä–∞—Ü–∏–∏"""

    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π Markdown —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    markdown_content = f"""# –†–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∞: {task_data['filename']}

## –û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã

- –ê—É–¥–∏–æ—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω
- –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {task_data['file_size']} –±–∞–π—Ç
- –ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: 95%
- ID –∑–∞–¥–∞—á–∏: {job_id}

## –°–æ–¥–µ—Ä–∂–∞–Ω–∏–µ

1. **–í–≤–µ–¥–µ–Ω–∏–µ** - –æ—Å–Ω–æ–≤–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã –≤—Å—Ç—Ä–µ—á–∏
2. **–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è** - –ø—Ä–∏–Ω—è—Ç—ã–µ —Ä–µ—à–µ–Ω–∏—è  
3. **Action items** - –∑–∞–¥–∞—á–∏ –Ω–∞ —Å–ª–µ–¥—É—é—â–∏–π –ø–µ—Ä–∏–æ–¥

### –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è

- **–ù–∞—á–∞–ª–æ –≤—Å—Ç—Ä–µ—á–∏**: 10:00
- **–£—á–∞—Å—Ç–Ω–∏–∫–∏**: 5 —á–µ–ª–æ–≤–µ–∫
- **–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–º—ã**: –ø–ª–∞–Ω —Ä–∞–∑—Ä–∞–±–æ—Ç–∫–∏, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –≤–æ–ø—Ä–æ—Å—ã

> –û–±—Ä–∞–±–æ—Ç–∞–Ω–æ —Å–µ—Ä–≤–∏—Å–æ–º Speak2MD
> –í—Ä–µ–º—è –æ–±—Ä–∞–±–æ—Ç–∫–∏: 2.5 —Å–µ–∫—É–Ω–¥—ã
"""

    # –°–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã–π JSON —Ä–µ–∑—É–ª—å—Ç–∞—Ç
    json_content = {
        "job_id": job_id,
        "filename": task_data['filename'],
        "file_size": task_data['file_size'],
        "status": "completed",
        "sections": [
            {
                "title": "–û—Å–Ω–æ–≤–Ω—ã–µ —Ç–µ–∑–∏—Å—ã",
                "content": [
                    "–ê—É–¥–∏–æ—Ñ–∞–π–ª —É—Å–ø–µ—à–Ω–æ –æ–±—Ä–∞–±–æ—Ç–∞–Ω",
                    f"–†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {task_data['file_size']} –±–∞–π—Ç",
                    "–ö–∞—á–µ—Å—Ç–≤–æ —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è: 95%"
                ]
            },
            {
                "title": "–ö–ª—é—á–µ–≤—ã–µ —Ä–µ—à–µ–Ω–∏—è",
                "content": [
                    "–†–µ–ª–∏–∑ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω –Ω–∞ —Å–ª–µ–¥—É—é—â—É—é –Ω–µ–¥–µ–ª—é",
                    "–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤—É—é —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –≤ API",
                    "–û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ø—Ä–æ—Ü–µ—Å—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏ –∞—É–¥–∏–æ"
                ]
            },
            {
                "title": "Action Items",
                "content": [
                    "–ó–∞–≤–µ—Ä—à–∏—Ç—å –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—é —Å —Ñ—Ä–æ–Ω—Ç–µ–Ω–¥–æ–º",
                    "–ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ —Ä–∞–∑–ª–∏—á–Ω—ã—Ö –∞—É–¥–∏–æ—Ñ–æ—Ä–º–∞—Ç–∞—Ö",
                    "–ü–æ–¥–≥–æ—Ç–æ–≤–∏—Ç—å –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏—é –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π"
                ]
            }
        ],
        "metadata": {
            "processing_time": "2.5 —Å–µ–∫—É–Ω–¥—ã",
            "service": "Speak2MD",
            "version": "0.1.0"
        }
    }

    # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ñ–∞–π–ª—ã —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤
    try:
        save_bytes(job_id, "result.md", markdown_content.encode('utf-8'))
        save_bytes(job_id, "result.json", json.dumps(json_content, ensure_ascii=False, indent=2).encode('utf-8'))

        print(f"‚úÖ –†–µ–∑—É–ª—å—Ç–∞—Ç—ã —Å–æ—Ö—Ä–∞–Ω–µ–Ω—ã –¥–ª—è –∑–∞–¥–∞—á–∏ {job_id}")
        print(f"   üìÑ result.md - {len(markdown_content)} —Å–∏–º–≤–æ–ª–æ–≤")
        print(f"   üìä result.json - {len(json.dumps(json_content))} —Å–∏–º–≤–æ–ª–æ–≤")

    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ –¥–ª—è {job_id}: {e}")