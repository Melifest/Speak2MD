<<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speak2MD — из аудио в Markdown</title>
<style>
  /* ====== Токены (взяты из стайл-гайда, адаптированы под новый градиент) ====== */
  :root{
    --bg1:#303D63; /* светлее (лево-верх) */
    --bg2:#0D1117; /* темнее (право-низ) */
    --text:#C9D1D9; --muted:#8B949E;
    --surface:#161B22; --border:#30363D;
    --accent:#58A6FF; --accent-2:#1F6FEB;
    --error:#F85149; --success:#3FB950;
    --radius:14px; --container:880px;
  }

  /* ====== Базовый фон с вариантами градиентов (легко переключать классом на body) ====== */
  body{
    margin:0;color:var(--text);font:400 16px/1.5 Inter,system-ui,sans-serif;
    min-height:100dvh;
    background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
    transition: background-position .25s ease;
  }
  /* Альтернативы — добавьте на <body> класс .bg-alt-1 / .bg-alt-2 / .bg-alt-3 */
  body.bg-alt-1{ background: linear-gradient(90deg, #054c76, #0c192a, #471c3a); }
  body.bg-alt-2{ background: linear-gradient(90deg, #15173c, #2375ef); }
  body.bg-alt-3{ background: linear-gradient(90deg, #050d33, #2974a3); }

  /* ====== Layout ====== */
  .container{max-width:var(--container);margin:0 auto;padding:24px}
  *,*::before,*::after{ box-sizing: border-box }
  html, body{ width:100%; overflow-x:hidden }
  header{
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(13,17,23,.72);
    border-bottom: 1px solid var(--border);
    isolation: isolate;
  }
  header .header-bar{
    position: relative;
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;flex-wrap:wrap;
    width:100%;
    padding:14px 24px;border-bottom:0;
  }
  #headerAuth{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  header .header-bar::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 0;
  }
  header .header-bar > *{ position:relative; z-index:1; }
  a{color:var(--text);text-decoration:none}
  a:hover{color:#fff}

  /* ====== Центр: единая панель Upload+Record ====== */
  .hero{display:grid;place-items:center;padding:8dvh 0}
  .panel{
    position:relative;
    isolation: isolate;
    background:rgba(22,27,34,.75);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:28px; max-width:640px; width:100%;
    box-shadow: 0 20px 60px rgba(0,0,0,.35), 0 0 0 1px rgba(255,255,255,.02) inset;
    animation: fadeIn .5s ease both;
  }
  /* "Свет за карточкой" — мягкая подсветка без тяжёлого blur'а */
  .panel::before{ display:none }
  .panel:hover::before{ transform:none }

  .h1{font-weight:600;font-size:30px;margin:0 0 10px}
  .muted{color:var(--muted)}

  /* Dropzone + Record = единая «кнопочная» область */
  .dropmix{
    border:2px dashed var(--border);border-radius:12px;padding:26px;text-align:center;cursor:pointer;
    transition:all .25s ease;background:rgba(255,255,255,.01);
    display:block; width:100%; max-width:560px; margin:0 auto; box-sizing:border-box;
  }
  .dropmix:hover, .dropmix.active{ border-color:var(--accent); background:rgba(88,166,255,.06) }
  .dropmix input{ display:none }
  .dropmix:focus{ outline: none }

  .row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  .btn{
    display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:12px 16px;font-weight:500;cursor:pointer;
    transition:transform .16s cubic-bezier(.2,.8,.2,1), box-shadow .2s ease, background .18s ease, color .18s ease;
    will-change:transform,box-shadow,background;
  }
  .btn:active{ transform: translateY(1px) }
  .btn:focus-visible{ outline: 2px solid var(--accent); outline-offset:2px }

  /* Primary CTA */
  .btn-primary{
    background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
    color:#fff; box-shadow:0 10px 24px rgba(88,166,255,.25);
  }
  .btn-primary:hover,
  .btn-primary:focus{ background:linear-gradient(90deg, #1F6FEB 0%, var(--accent-2) 100%); transform:translateY(-2px); box-shadow:0 18px 40px rgba(31,111,235,.28) }

  /* Ghost / secondary */
  .btn-ghost{ background:transparent; color:var(--accent); border:1px solid rgba(88,166,255,.18) }
  .btn-ghost:hover, .btn-ghost:focus{ background:rgba(88,166,255,.06); border-color:var(--accent); color:#FFFFFF; transform:translateY(-2px); box-shadow:0 8px 20px rgba(88,166,255,.12) }
  .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px}
  .badge-ready{background:var(--success);color:#0D1117}

  /* Прогресс (липкий) */
  .sticky{ position:sticky; top:72px; z-index:12; margin-top:16px }
  .progress{height:8px;background:#21262D;border-radius:5px;overflow:hidden;box-shadow: inset 0 0 0 1px rgba(255,255,255,.03)}
  .bar{height:100%;width:0;background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);position:relative;transition:width .3s;box-shadow:0 0 0 1px rgba(255,255,255,.06) inset}
  .bar::after{content:"";position:absolute;inset:0;background:linear-gradient(90deg, transparent, rgba(255,255,255,.35), transparent);animation:shimmer 1.6s infinite}

  /* Markdown Preview */
  .preview{display:none;margin-top:16px;background:#161B22;border:1px solid var(--border);border-radius:10px;padding:22px;white-space:pre-wrap;font-family: ui-monospace, SFMono-Regular, Menlo, Consolas, monospace; font-size:14px; line-height:1.6; max-height:50vh; overflow:auto; box-shadow: 0 12px 32px rgba(0,0,0,.22)}
  .meta{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}

  /* Микрофон: минималистичные "bars" во время записи */
  .bars{display:inline-flex;gap:4px;height:24px;align-items:flex-end;margin-left:10px}
  .barv{width:3px;height:6px;background:#30363D;border-radius:2px;animation:bars 1s ease-in-out infinite}
  .barv:nth-child(2){animation-delay:.1s}.barv:nth-child(3){animation-delay:.2s}.barv:nth-child(4){animation-delay:.3s}.barv:nth-child(5){animation-delay:.4s}

  /* «Как это работает» */
  /* Всегда поверх фонового грida (p5 canvas) */
  .how{margin:72px 0; position:relative; z-index:2}
  .how{margin:72px 0; display:flex;flex-direction:column;align-items:center}
  .how h2{ text-align:center; }
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;justify-items:center;max-width:var(--container);width:100%;}
  .card{background:#161B22;border:1px solid var(--border);border-radius:12px;padding:18px;transition:border-color .2s, transform .2s, box-shadow .2s; position:relative; z-index:1}
  .card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(88,166,255,.15)}

  /* Анимации */
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  @keyframes bars{0%,100%{height:6px;background:#30363D}50%{height:24px;background:var(--accent)}}

  /* Доступность и адаптив */
  .sr-only{position:absolute;left:-9999px}

  /* ВКЛ по необходимости: <body class="debug-noblur"> */
  .debug-noblur *{
    filter: none !important;
    backdrop-filter: none !important;
  }
  /* Force the .how section itself to be centered in the viewport */
  section.how.container{ max-width:100%; width:100%; padding-left:24px; padding-right:24px; box-sizing:border-box }
  section.how{ display:flex; justify-content:center }
  .how > .grid{ margin:0 auto; max-width:var(--container); }
  @media (max-width:960px){ .grid{grid-template-columns:1fr} .container{padding:18px} .panel{padding:22px} }
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important;transition:none !important}
  }

  /* Trailing grid container (p5.js) */
  #trail-grid { position: fixed; inset: 0; z-index: 0; pointer-events: none; }
  @media (prefers-reduced-motion: reduce) { #trail-grid { display: none !important; } }
  body.trail-disabled #trail-grid{ display:none }
  #trailToggle{ position:fixed; right:12px; bottom:12px; z-index:20; background:rgba(13,17,23,.6); color:var(--text); border:1px solid var(--border); padding:8px 10px; border-radius:10px; cursor:pointer; font-size:13px }
  #trail-grid{ overflow:hidden }
  #trail-grid canvas{ display:block }

  /* Для модалок */
  .modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
  }

  .modal.hidden{
  display:none;
  }

  .modal-box{
  background:var(--surface);
  padding:24px;
  border:1px solid var(--border);
  border-radius:12px;
  width:320px;
  display:flex;
  flex-direction:column;
  gap:12px;
  }
  .modal-box input{
    width:100%;
    background:#0D1117;
    color:var(--text);
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px 14px;
    outline:none;
    transition:border-color .18s, box-shadow .18s, background .18s;
    appearance:none;
  }
  .modal-box input::placeholder{ color:var(--muted) }
  .modal-box input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(88,166,255,.18); background:#0b1220 }

  .btn-secondary{ background:#F0F6FC; color:#0D1117 }
  .btn-secondary:hover, .btn-secondary:focus{ background:#E6EDF3; color:#0D1117; transform:translateY(-2px); box-shadow:0 8px 20px rgba(88,166,255,.12) }

   /* Ошибка */
  .toast{
  position:fixed;
  right:16px;
  bottom:16px;
  background:var(--error);
  padding:14px 18px;
  border-radius:10px;
  color:#fff;
  z-index:1000;
  animation:fadeIn .2s ease;
  }

</style>
</head>
<body class="">
  <div id="trail-grid"></div>
  <button id="trailToggle" aria-pressed="true" title="Toggle trail">trail</button>
  <header>
    <div class="container header-bar">
      <strong>Speak2MD</strong>

      <div id="headerAuth">
         <!-- Если НЕ залогинен → кнопки -->
         <button id="btnLoginOpen" class="btn btn-primary">Войти</button>
         <button id="btnRegisterOpen" class="btn btn-secondary">Регистрация</button>
      </div>
    </div>
  </header>

  <main class="container hero">
    <section class="panel" aria-labelledby="title">
      <h1 id="title" class="h1">Из аудио — в Markdown</h1>
      <p class="muted">Перетащите файл или запишите голос. Поддерживаются mp3/m4a/wav; лимиты Free: ≤ 50 МБ · ≤ 120 мин. <!-- требования MVP --> </p>

      <!-- Объединённая зона: загрузка + запись -->
      <label id="mix" class="dropmix" tabindex="0" aria-label="Загрузить аудиофайл или записать">
        <input id="fileInput" type="file" accept=".mp3,.m4a,.wav,.webm,.ogg" />
        <div><strong>Перетащите файл сюда</strong> или <u>выберите</u>…</div>
        <div class="muted" style="margin-top:6px">…или нажмите «Запись» ниже</div>
      </label>

      <div class="row" style="margin-top:14px">
        <button id="btnUpload" class="btn btn-primary">Загрузить аудио</button>
        <button id="btnRecord" class="btn btn-ghost" aria-pressed="false">
          <span id="recLabel">Запись</span>
          <span class="bars" aria-hidden="true"><i class="barv"></i><i class="barv"></i><i class="barv"></i><i class="barv"></i><i class="barv"></i></span>
        </button>
        <small id="recTimer" class="muted" aria-live="polite"></small>
      </div>

      <!-- Прогресс -->
      <div id="statusBox" style="display:none; margin-top:16px">
        <div style="display:flex;align-items:center;justify-content:space-between;gap:12px;background:#161B22;border:1px solid var(--border);border-radius:10px;padding:12px">
          <div id="statusText" aria-live="polite"><strong>Обработка…</strong> (VAD → ASR → Разметка)</div>
          <span id="pct" class="muted" aria-live="polite" style="margin-left:8px;min-width:42px;text-align:right">0%</span>
          <button id="cancelBtn" class="btn btn-ghost">Отменить</button>
        </div>
        <div class="progress" style="margin-top:8px"><div id="bar" class="bar"></div></div>
      </div>

      <!-- Результат -->
      <div id="meta" class="meta" style="display:none">
        <span class="badge badge-ready">Готово</span>
        <div class="row">
          <a id="dlMd" class="btn btn-primary" download>Скачать .md</a>
          <a id="dlJson" class="btn btn-ghost" download>JSON</a>
        </div>
      </div>
      <pre id="preview" class="preview" aria-label="Предпросмотр Markdown (сырой)"></pre>
      <div id="rendered" class="preview" aria-label="Рендер Markdown (красивый)" style="display:none"></div>

      <p class="muted" style="margin-top:14px">
        Форматы/лимиты и прогресс соответствуют MVP‑требованиям (WS/SSE, .md/.json). <!-- док‑основания -->
      </p>
    </section>
  </main>

  <section id="how" class="container how">
    <h2 style="margin:0 0 12px">Как это работает</h2>
    <div class="grid">
      <div class="card"><strong>1. Загрузка/Запись</strong><div class="muted">Файл mp3/m4a/wav или запись</div></div>
      <div class="card"><strong>2. Обработка</strong><div class="muted">VAD → ASR → структурирование</div></div>
      <div class="card"><strong>3. Результат</strong><div class="muted">Предпросмотр → скачать .md</div></div>
    </div>
  </section>

  <footer class="container" style="padding:48px 0;color:var(--muted)">
    © Speak2MD · Мини‑MVP
  </footer>

<script>
/* ====== Реакция фона на курсор (аккуратно и дёшево) ====== */
// Удаляем случайный одиночный символ "<", если он оказался текстовым узлом в body
document.addEventListener('DOMContentLoaded', ()=>{
  for(const node of Array.from(document.body.childNodes)){
    if(node.nodeType===3 && node.nodeValue && node.nodeValue.trim()==='<') node.parentNode.removeChild(node);
  }
});

addEventListener('pointermove', (e)=>{
  const x = (e.clientX / innerWidth * 100).toFixed(2) + '%';
  const y = (e.clientY / innerHeight * 100).toFixed(2) + '%';
  document.body.style.setProperty('--mx', x);
  document.body.style.setProperty('--my', y);
});

/* ====== Единая панель: загрузка ====== */
const dz = document.getElementById('mix');
 const fileInput = document.getElementById('fileInput');
 const pct = document.getElementById('pct');
const btnUpload = document.getElementById('btnUpload');

dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('active'); });
dz.addEventListener('dragleave', () => dz.classList.remove('active'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('active');
  const f = e.dataTransfer.files?.[0]; if (f) startUpload(f);
});
dz.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const f = e.target.files?.[0]; if (f) startUpload(f);
});
btnUpload.addEventListener('click', ()=> fileInput.click());

/* ====== Запись (минимум кода, максимум UX) ====== */
const btnRecord = document.getElementById('btnRecord');
const recLabel = document.getElementById('recLabel');
const recTimer = document.getElementById('recTimer');
let mediaRecorder, recChunks=[], recStart=0, recT;

btnRecord.addEventListener('click', async ()=>{
  if (!mediaRecorder || mediaRecorder.state==='inactive'){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    // Явно выбираем поддерживаемый MIME тип с фолбэками
    let preferred = 'audio/webm;codecs=opus';
    if (!window.MediaRecorder || !MediaRecorder.isTypeSupported(preferred)){
      preferred = MediaRecorder && MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')
        ? 'audio/ogg;codecs=opus'
        : (MediaRecorder && MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '');
    }
    mediaRecorder = preferred ? new MediaRecorder(stream, { mimeType: preferred }) : new MediaRecorder(stream);
    recChunks = [];
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) recChunks.push(e.data); };
    // Blob+отправка только после полной остановки (включая финальный чанк)
    mediaRecorder.onstop = ()=> {
      clearInterval(recT); recTimer.textContent='';
      let type = mediaRecorder.mimeType || (recChunks[0]?.type) || '';
      if (!type) {
        const ua = (navigator.userAgent || '').toLowerCase();
        // В Firefox чаще всего контейнер OGG, если тип не установлен
        if (ua.includes('firefox')) type = 'audio/ogg;codecs=opus';
        else type = 'audio/webm;codecs=opus';
      }
      const blob = new Blob(recChunks, { type });
      // выберем расширение
      let ext = 'webm';
      const mt = String(blob.type || '').toLowerCase();
      if (mt.includes('ogg')) ext = 'ogg';
      else if (mt.includes('webm')) ext = 'webm';
      else if (mt.includes('wav')) ext = 'wav';
      else if (mt.includes('mp4')) ext = 'm4a';
      const file = new File([blob], `record.${ext}`, { type: blob.type });
      recChunks = [];
      startUpload(file);
    };
    mediaRecorder.start(); recStart = Date.now();
    btnRecord.setAttribute('aria-pressed','true'); recLabel.textContent='Идёт запись…';
    recT = setInterval(()=>{
      const s = Math.floor((Date.now()-recStart)/1000);
      recTimer.textContent = String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
    }, 500);
  }else{
    mediaRecorder.stop();
    btnRecord.setAttribute('aria-pressed','false'); recLabel.textContent='Запись';
  }
});

/* ====== Прогресс/результат ====== */
const statusBox = document.getElementById('statusBox');
const statusText = document.getElementById('statusText');
const bar = document.getElementById('bar');
const cancelBtn = document.getElementById('cancelBtn');
const meta = document.getElementById('meta');
const preview = document.getElementById('preview');
const dlMd = document.getElementById('dlMd');
const dlJson = document.getElementById('dlJson');
let jobId=null, ws=null, poll=null;

async function startUpload(file){
  if (!/\.(mp3|m4a|wav)$/i.test(file.name) && !/webm|ogg/i.test(file.type)){
    alert('Поддерживаются mp3/m4a/wav (запись — webm/ogg)'); return; /* FR-001 */
  }
  if (file.size > 50*1024*1024){ alert('Файл больше 50 МБ'); return; } /* FR-002 */

  const fd = new FormData(); fd.append('file', file);
  const res = await fetch('/api/upload', {method:'POST', body:fd});
  if(!res.ok){ alert('Ошибка загрузки'); return; }
  const data = await res.json(); jobId = data.job_id;

  statusBox.style.display=''; meta.style.display='none'; preview.style.display='none';
  bar.style.width='0%'; statusText.innerHTML='<strong>Обработка…</strong> (VAD → ASR → Разметка)';
  if(pct) pct.textContent = '0%';

  connectWS(jobId);
}
cancelBtn.addEventListener('click', ()=>{ try{ ws?.close?.(); }catch{} if(poll){ clearInterval(poll); poll=null; } statusText.textContent='Отменено'; });

function handleProgress(p){
  if (typeof p.progress==='number'){
    const v = Math.max(0, Math.min(100, p.progress));
    bar.style.width = v + '%';
    if(pct) pct.textContent = String(Math.round(v)) + '%';
  }
  if (p.status==='ready'){ try{ ws?.close?.(); }catch{} if(poll){ clearInterval(poll); poll=null; } loadResult(); }
  if (p.status==='error'){ try{ ws?.close?.(); }catch{} if(poll){ clearInterval(poll); poll=null; } statusText.textContent='Ошибка обработки'; }
  if (p.message){ statusText.textContent = p.message; }
}

function startPolling(jobId){
  if(poll) return;
  poll = setInterval(async ()=>{
    try{
      const r = await fetch(`/api/status/${jobId}`);
      if(r.ok){ const p = await r.json(); handleProgress(p); }
    }catch{}
  }, 1200);
}

function connectWS(jobId){
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  try{
    ws = new WebSocket(`${proto}://${location.host}/api/ws/${jobId}`);
    ws.onmessage = (e)=>{
      try{
        const msg = JSON.parse(e.data);
        if (msg && msg.event === 'progress' && msg.data){ handleProgress(msg.data); }
      }catch{}
    };
    ws.onclose = ()=>{ startPolling(jobId); };
    ws.onerror = ()=>{ try{ ws.close(); }catch{} startPolling(jobId); };
  }catch{ startPolling(jobId); }
}

async function loadResult(){
  statusText.textContent='Готово';
  const md = await fetch(`/api/result/${jobId}?format=markdown`).then(r=>r.text());
  // Заполняем сырой Markdown, но показываем только красивый рендер.
  preview.textContent = md;
  const rendered = document.getElementById('rendered');
  if(window.marked && rendered){
    rendered.innerHTML = window.marked.parse(md);
    rendered.style.display='block';
    preview.style.display='none';
  } else {
    // Фолбэк: если marked не загрузился — показываем сырой Markdown
    preview.style.display='block';
  }
  if(pct) pct.textContent = '100%';
  meta.style.display='flex';
  dlMd.href = `/api/result/${jobId}?format=markdown`;
  dlJson.href = `/api/result/${jobId}?format=json`;
}

/* ====== Мелкая полировка: клавиатура для dropzone ====== */
dz.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); }});

/* Открытие/Закрытие модалок */
function showModal(id){
  document.getElementById(id).classList.remove("hidden");
}

function hideModal(id){
  document.getElementById(id).classList.add("hidden");
}

document.getElementById("btnLoginOpen").onclick = () => showModal("modalLogin");
document.getElementById("btnRegisterOpen").onclick = () => showModal("modalRegister");

/* Ошибка */
function showError(msg){
  const t = document.createElement("div");
  t.className = "toast";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 3000);
}

/* Регистрация */
document.getElementById("btnRegisterSubmit").onclick = async () => {
  const payload = {
    name: document.getElementById("regName").value,
    email: document.getElementById("regEmail").value,
    password: document.getElementById("regPassword").value,
  };

  const r = await fetch("/api/auth/register", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  if (r.status === 400) return showError("Ошибка регистрации");

  if (!r.ok) return showError("Сервер недоступен");

  const data = await r.json();

  // сохранить токены (функция будет в JWT-клиенте)
  saveTokens(data);

  hideModal("modalRegister");
  updateHeaderAuth();
};

/* Вход */
document.getElementById("btnLoginSubmit").onclick = async () => {
  const payload = {
    email: document.getElementById("loginEmail").value,
    password: document.getElementById("loginPassword").value,
  };

  const r = await fetch("/api/auth/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  if (r.status === 401) return showError("Неверный логин или пароль");

  if (!r.ok) return showError("Ошибка сервера");

  const data = await r.json();

  saveTokens(data);

  hideModal("modalLogin");
  updateHeaderAuth();
};

/* Смена состояния хедера («гость ↔ залогинен») */
function updateHeaderAuth(){
  const box = document.getElementById("headerAuth");
  const user = getUser(); 

  if (!user){
    box.innerHTML = `
      <button id="btnLoginOpen" class="btn btn-primary">Войти</button>
      <button id="btnRegisterOpen" class="btn btn-secondary">Регистрация</button>
    `;
    document.getElementById("btnLoginOpen").onclick = () => showModal("modalLogin");
    document.getElementById("btnRegisterOpen").onclick = () => showModal("modalRegister");
    return;
  }

  box.innerHTML = `
    <span>${user.name}</span>
    <span class="badge badge-${user.plan}">${user.plan}</span>
  `;
}

// p5.js trailing grid implementation will be loaded below
</script>
<!-- p5.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

<!-- Markdown render (marked) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- Trailing Grid (p5.js) sketch -->
<script>
(function () {
  const HOST = document.getElementById('trail-grid');
  if(!HOST) return;

  const CONFIG = {
    cell: 36,
    margin: 48,
    influence: 160, // distance in px where lines light up
    baseAlpha: 24,  // base line alpha (0-255)
    highlightAlpha: 220, // max alpha for highlighted line
    lineWidth: 1.2,
    maxPoints: 2500
  };

  new p5((p) => {
    let pts = [];
    let cols = 0, rows = 0, cell = CONFIG.cell;
    let mpos;
    let w = 0, h = 0;

    function rebuild() {
      w = HOST.clientWidth || window.innerWidth;
      h = HOST.clientHeight || window.innerHeight;
      if (!p.canvas) p.createCanvas(w, h); else p.resizeCanvas(w, h, true);
      cell = CONFIG.cell;
      cols = Math.max(1, Math.floor((w - CONFIG.margin * 2) / cell));
      rows = Math.max(1, Math.floor((h - CONFIG.margin * 2) / cell));
      const total = cols * rows;
      const stride = total > CONFIG.maxPoints ? Math.ceil(total / CONFIG.maxPoints) : 1;
      pts = [];
      let idx = 0;
      // make grid cover full viewport without visible margins
      const startX = -cell;
      const startY = -cell;
      const fullCols = Math.ceil(w / cell) + 3;
      const fullRows = Math.ceil(h / cell) + 3;
      for (let r = 0; r < fullRows; r++){
        for (let c = 0; c < fullCols; c++){
          if ((idx++ % stride) !== 0) continue;
          const x0 = startX + c * cell;
          const y0 = startY + r * cell;
          pts.push({ x0, y0, c, r, i: pts.length, neigh: {} });
        }
      }
      // assign neighbors by spatial lookup (approximate grid coords)
      const grid = {};
      for(const pnt of pts){
        const key = `${Math.round(pnt.x0)},${Math.round(pnt.y0)}`;
        grid[key] = pnt;
      }
      function findAt(x,y){ return grid[`${Math.round(x)},${Math.round(y)}`]; }
      for(const pnt of pts){
        // neighbours are at +/- cell offsets
        const up = findAt(pnt.x0, pnt.y0 - cell); if(up) pnt.neigh.up = up;
        const down = findAt(pnt.x0, pnt.y0 + cell); if(down) pnt.neigh.down = down;
        const left = findAt(pnt.x0 - cell, pnt.y0); if(left) pnt.neigh.left = left;
        const right = findAt(pnt.x0 + cell, pnt.y0); if(right) pnt.neigh.right = right;
      }
    }

    p.setup = () => {
      rebuild();
      p.pixelDensity(Math.max(1, Math.min(2, window.devicePixelRatio || 1)));
      p.noStroke();
      mpos = p.createVector(w * 0.5, h * 0.5);
    };

    p.windowResized = rebuild;

    p.mouseMoved = () => { mpos.set(p.mouseX, p.mouseY); };
    p.touchMoved = () => { if (p.touches && p.touches.length){ const t = p.touches[p.touches.length - 1]; mpos.set(t.x, t.y); } return false; };

    document.addEventListener('visibilitychange', () => { if (document.hidden) p.noLoop(); else p.loop(); });

    p.draw = () => {
      p.clear();
      // draw faint base lines
      p.strokeWeight(CONFIG.lineWidth);
      for(const pt of pts){
        for(const dir of ['right','down']){
          const nb = pt.neigh[dir];
          if(!nb) continue;
          p.stroke(88,166,255, CONFIG.baseAlpha);
          p.line(pt.x0, pt.y0, nb.x0, nb.y0);
        }
      }

      // highlight lines near cursor
      for(const pt of pts){
        const d = p.dist(mpos.x, mpos.y, pt.x0, pt.y0);
        if(d > CONFIG.influence) continue;
        const t = 1 - (d / CONFIG.influence);
        const alpha = Math.round(CONFIG.highlightAlpha * t);
        p.stroke(88,166,255, alpha);
        p.strokeWeight(CONFIG.lineWidth + 1.2 * t);
        // draw lines to all 4 neighbors (will overlap but that's fine)
        for(const dir of ['up','right','down','left']){
          const nb = pt.neigh[dir]; if(!nb) continue;
          p.line(pt.x0, pt.y0, nb.x0, nb.y0);
        }
      }
    };

  }, HOST);

  // toggle button
  const btn = document.getElementById('trailToggle');
  let enabled = true;
  btn.addEventListener('click', ()=>{
    enabled = !enabled; btn.setAttribute('aria-pressed', String(enabled));
    document.body.classList.toggle('trail-disabled', !enabled);
    const canv = HOST.querySelector('canvas'); if(canv){ const sketch = canv._pInst; if(sketch){ if(!enabled) sketch.noLoop(); else sketch.loop(); }}
  });

})();
</script>
<!-- модалка входа -->
<div id="modalLogin" class="modal hidden">
  <div class="modal-box">
    <h3>Вход</h3>
    <input id="loginEmail" type="email" placeholder="Email">
    <input id="loginPassword" type="password" placeholder="Пароль">
    <button id="btnLoginSubmit" class="btn btn-primary">Войти</button>
    <button class="btn btn-ghost" onclick="hideModal('modalLogin')">Закрыть</button>
  </div>
</div>

<!-- модалка регистрации -->
<div id="modalRegister" class="modal hidden">
  <div class="modal-box">
    <h3>Регистрация</h3>
    <input id="regName" type="text" placeholder="Имя">
    <input id="regEmail" type="email" placeholder="Email">
    <input id="regPassword" type="password" placeholder="Пароль">
    <button id="btnRegisterSubmit" class="btn btn-primary">Зарегистрироваться</button>
    <button class="btn btn-ghost" onclick="hideModal('modalRegister')">Закрыть</button>
  </div>
</div>

</body>
</html>