<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Speak2MD ‚Äî –∏–∑ –∞—É–¥–∏–æ –≤ Markdown</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  /*–¢–æ–∫–µ–Ω—ã (–≤–∑—è—Ç—ã –∏–∑ —Å—Ç–∞–π–ª-–≥–∞–π–¥–∞, –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã –ø–æ–¥ –Ω–æ–≤—ã–π –≥—Ä–∞–¥–∏–µ–Ω—Ç*/
  :root{
    --bg1:#303D63; /* —Å–≤–µ—Ç–ª–µ–µ (–ª–µ–≤–æ-–≤–µ—Ä—Ö) */
    --bg2:#0D1117; /* —Ç–µ–º–Ω–µ–µ (–ø—Ä–∞–≤–æ-–Ω–∏–∑) */
    --text:#C9D1D9; --muted:#8B949E;
    --surface:#161B22; --border:#30363D;
    --accent:#58A6FF; --accent-2:#1F6FEB;
    --error:#F85149; --success:#3FB950;
    --radius:14px; --container:880px;
  }

  /* –ë–∞–∑–æ–≤—ã–π —Ñ–æ–Ω —Å –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –≥—Ä–∞–¥–∏–µ–Ω—Ç–æ–≤ */
  body{
    margin:0;color:var(--text);font:400 16px/1.5 Inter,system-ui,sans-serif;
    min-height:100dvh;
    background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 100%);
    transition: background-position .25s ease;
  }
  /* –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤—ã ‚Äî –¥–æ–±–∞–≤—å—Ç–µ –Ω–∞ <body> –∫–ª–∞—Å—Å .bg-alt-1 / .bg-alt-2 / .bg-alt-3 */
  body.bg-alt-1{ background: linear-gradient(90deg, #054c76, #0c192a, #471c3a); }
  body.bg-alt-2{ background: linear-gradient(90deg, #15173c, #2375ef); }
  body.bg-alt-3{ background: linear-gradient(90deg, #050d33, #2974a3); }

  /* Layou*/
  .container{max-width:var(--container);margin:0 auto;padding:24px}
  *,*::before,*::after{ box-sizing: border-box }
  html, body{ width:100%; overflow-x:hidden }
  header{
    position: sticky;
    top: 0;
    z-index: 10;
    background: rgba(13,17,23,.72);
    border-bottom: 1px solid var(--border);
    isolation: isolate;
  }
  header .header-bar{
    position: relative;
    display:flex;align-items:center;justify-content:space-between;
    gap:12px;flex-wrap:wrap;
    width:100%;
    padding:14px 24px;border-bottom:0;
  }
  #headerAuth{ display:flex; align-items:center; gap:10px; flex-wrap:wrap }
  header .header-bar::before{
    content:"";
    position:absolute; inset:0;
    pointer-events:none;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    border-radius: 0;
  }
  header .header-bar > *{ position:relative; z-index:1; }
  a{color:var(--text);text-decoration:none}
  a:hover{color:#fff}
  #bg-canvas{ position: fixed; inset: 0; z-index: 0; mix-blend-mode: screen; opacity: .6 }
  .logo{ font-weight: 700; font-size: 20px; color: #fff; text-decoration: none; display: flex; align-items: center; gap: 10px }
  .logo-icon{ width: 24px; height: 24px; background: linear-gradient(135deg, var(--accent), var(--accent-2)); border-radius: 6px; box-shadow: 0 0 12px var(--accent) }

  /* ====== –¶–µ–Ω—Ç—Ä: –µ–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å Upload+Record ====== */
  .hero{display:grid;place-items:center;padding:8dvh 0}
  .glass-panel{ position: relative; width: 100%; background: rgba(22,27,34,.65); backdrop-filter: blur(24px); border-radius: 24px; padding: 48px; box-shadow: 0 24px 60px -12px rgba(0,0,0,.6); background-clip: padding-box; border: 1px solid transparent; max-width: 880px; animation: fadeIn .5s ease both }
  .title-main{ font-size:42px; font-weight:700; margin:0 0 16px; text-align:center; line-height:1.1; background: linear-gradient(135deg, #fff 0%, #b0c4de 100%); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-shadow: 0 0 30px rgba(255,255,255,.1) }
  .title-sub{ text-align:center; color: var(--muted); font-size:18px; max-width:600px; margin:0 auto 40px }
  /* "–°–≤–µ—Ç –∑–∞ –∫–∞—Ä—Ç–æ—á–∫–æ–π" ‚Äî –º—è–≥–∫–∞—è –ø–æ–¥—Å–≤–µ—Ç–∫–∞ –±–µ–∑ —Ç—è–∂—ë–ª–æ–≥–æ blur'–∞ */
  .panel::before{ display:none }
  .panel:hover::before{ transform:none }

  .h1{font-weight:600;font-size:30px;margin:0 0 10px}
  .muted{color:var(--muted)}

  /* Dropzone + Record = –µ–¥–∏–Ω–∞—è ¬´–∫–Ω–æ–ø–æ—á–Ω–∞—è¬ª –æ–±–ª–∞—Å—Ç—å */
  .dropzone{ position: relative; border: 2px dashed rgba(255,255,255,.1); border-radius: 16px; background: rgba(0,0,0,.2); padding: 40px; text-align: center; transition: all .3s cubic-bezier(.175,.885,.32,1.275); cursor: pointer; overflow: hidden; display:block; width:100%; max-width:560px; margin:0 auto; box-sizing:border-box }
  .dropzone:hover{ border-color: var(--accent-2); background: rgba(88,166,255,.03); transform: scale(1.01); box-shadow: 0 10px 30px -10px rgba(88,166,255,.15) }
  .dropzone.active{ border-color: var(--accent); background: rgba(88,166,255,.1) }
  .dropzone input{ display: none }
  .dropzone:focus{ outline: none }
  .dz-icon{ width:56px; height:56px; margin:0 auto 16px; background: rgba(255,255,255,.05); border-radius: 50%; display:flex; align-items:center; justify-content:center; color: var(--muted); transition:.3s }
  .dropzone:hover .dz-icon{ background: var(--accent-2); color: #fff; box-shadow: 0 0 20px var(--accent-2) }

  .row{display:flex;gap:12px;align-items:center;justify-content:center;flex-wrap:wrap}
  .actions-row{ display:flex; gap:16px; justify-content:center; margin-top: 32px; flex-wrap:wrap }
  .btn{
    display:inline-flex;align-items:center;gap:8px;border:0;border-radius:10px;padding:12px 16px;font-weight:500;cursor:pointer;
    transition:transform .16s cubic-bezier(.2,.8,.2,1), box-shadow .2s ease, background .18s ease, color .18s ease;
    will-change:transform,box-shadow,background;
  }
  .btn:active{ transform: translateY(1px) }
  .btn:focus-visible{ outline: 2px solid var(--accent); outline-offset:2px }

  /* Primary CTA */
  .btn-primary{
    background:linear-gradient(90deg, var(--accent) 0%, var(--accent-2) 100%);
    color:#fff; box-shadow:0 10px 24px rgba(88,166,255,.25);
  }
  .btn-primary:hover,
  .btn-primary:focus{ background:linear-gradient(90deg, #1F6FEB 0%, var(--accent-2) 100%); transform:translateY(-2px); box-shadow:0 18px 40px rgba(31,111,235,.28) }

  /* Ghost / secondary */
  .btn-ghost{ background:transparent; color:var(--accent); border:1px solid rgba(88,166,255,.18) }
  .btn-ghost:hover, .btn-ghost:focus{ background:rgba(88,166,255,.06); border-color:var(--accent); color:#FFFFFF; transform:translateY(-2px); box-shadow:0 8px 20px rgba(88,166,255,.12) }
  .badge{display:inline-block;padding:4px 10px;border-radius:12px;font-size:12px}
  .badge-ready{background:var(--success);color:#0D1117}

  /* –ü—Ä–æ–≥—Ä–µ—Å—Å (–ª–∏–ø–∫–∏–π) */
  .sticky{ position:sticky; top:72px; z-index:12; margin-top:16px }
  .progress-wrap{ height:6px; background: rgba(255,255,255,.05); border-radius: 10px; overflow: hidden; margin-top: 10px }
  .progress-fill{ height:100%; width:0; background: linear-gradient(90deg, var(--accent-2), var(--accent)); box-shadow: 0 0 15px var(--accent-2); transition: width .3s; position: relative }
  .progress-fill::after{ content:""; position:absolute; inset:0; background: linear-gradient(90deg, transparent, #fff, transparent); opacity:.4; transform: translateX(-100%); animation: shimmer 1.5s infinite }

  /* Markdown Preview */
  .preview{display:none;margin-top:30px;background:#050608;border:1px solid rgba(255,255,255,.1);border-radius:12px;padding:24px;white-space:pre-wrap;font-family:'JetBrains Mono', monospace; font-size:13px; line-height:1.6; max-height:400px; overflow:auto; box-shadow: inset 0 2px 10px rgba(0,0,0,.5); color:#d1d5db}
  .preview::-webkit-scrollbar{ width:8px }
  .preview::-webkit-scrollbar-thumb{ background:#333; border-radius:4px }
  .meta{display:flex;gap:8px;align-items:center;justify-content:space-between;flex-wrap:wrap;margin-top:10px}

  /* –ú–∏–∫—Ä–æ—Ñ–æ–Ω: –º–∏–Ω–∏–º–∞–ª–∏—Å—Ç–∏—á–Ω—ã–µ "bars" –≤–æ –≤—Ä–µ–º—è –∑–∞–ø–∏—Å–∏ */
  .bars{display:inline-flex;gap:4px;height:24px;align-items:flex-end;margin-left:10px}
  .barv{width:3px;height:6px;background:#30363D;border-radius:2px;animation:bars 1s ease-in-out infinite}
  .barv:nth-child(2){animation-delay:.1s}.barv:nth-child(3){animation-delay:.2s}.barv:nth-child(4){animation-delay:.3s}.barv:nth-child(5){animation-delay:.4s}

  /* ¬´–ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç¬ª */
  /* –í—Å–µ–≥–¥–∞ –ø–æ–≤–µ—Ä—Ö —Ñ–æ–Ω–æ–≤–æ–≥–æ –≥—Äida (p5 canvas) */
  .how{margin:72px 0; position:relative; z-index:2}
  .how{margin:72px 0; display:flex;flex-direction:column;align-items:center}
  .how h2{ text-align:center; }
  .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:20px;justify-items:center;max-width:var(--container);width:100%;}
  .card{background:#161B22;border:1px solid var(--border);border-radius:12px;padding:18px;transition:border-color .2s, transform .2s, box-shadow .2s; position:relative; z-index:1}
  .card:hover{border-color:var(--accent);transform:translateY(-2px);box-shadow:0 8px 24px rgba(88,166,255,.15)}

  /* –ê–Ω–∏–º–∞—Ü–∏–∏ */
  @keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
  @keyframes shimmer{0%{transform:translateX(-100%)}100%{transform:translateX(100%)}}
  @keyframes bars{0%,100%{height:6px;background:#30363D}50%{height:24px;background:var(--accent)}}

  /* –î–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –∏ –∞–¥–∞–ø—Ç–∏–≤ */
  .sr-only{position:absolute;left:-9999px}

  /* –í–ö–õ –ø–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏: <body class="debug-noblur"> */
  .debug-noblur *{
    filter: none !important;
    backdrop-filter: none !important;
  }
  /* Force the .how section itself to be centered in the viewport */
  section.how.container{ max-width:100%; width:100%; padding-left:24px; padding-right:24px; box-sizing:border-box }
  section.how{ display:flex; justify-content:center }
  .how > .grid{ margin:0 auto; max-width:var(--container); }
  @media (max-width:960px){ .grid{grid-template-columns:1fr} .container{padding:18px} .panel{padding:22px} }
  @media (prefers-reduced-motion: reduce){
    *{animation:none !important;transition:none !important}
  }

  /* Trailing grid container (p5.js) */
  .features-grid{ display:grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap:24px; margin-top:60px }
  .feature-card{ background: rgba(255,255,255,.03); border:1px solid rgba(255,255,255,.05); border-radius:16px; padding:24px; transition:.3s; position:relative; overflow:hidden }
  .feature-card:hover{ transform: translateY(-5px); background: rgba(255,255,255,.06); border-color: var(--accent-2) }
  .feature-card::before{ content:""; position:absolute; top:-50px; right:-50px; width:100px; height:100px; background: var(--accent-2); filter: blur(60px); opacity:0; transition:.4s }
  .feature-card:hover::before{ opacity:.2 }

  /* –î–ª—è –º–æ–¥–∞–ª–æ–∫ */
  .modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.5);
  display:flex;
  justify-content:center;
  align-items:center;
  z-index:999;
  }

  .modal.hidden{
  display:none;
  }

  .modal-box{
  background:var(--surface);
  padding:24px;
  border:1px solid var(--border);
  border-radius:12px;
  width:320px;
  display:flex;
  flex-direction:column;
  gap:12px;
  }
  .modal-box input{
    width:100%;
    background:#0D1117;
    color:var(--text);
    border:1px solid var(--border);
    border-radius:10px;
    padding:12px 14px;
    outline:none;
    transition:border-color .18s, box-shadow .18s, background .18s;
    appearance:none;
  }
  .modal-box input::placeholder{ color:var(--muted) }
  .modal-box input:focus{ border-color:var(--accent); box-shadow:0 0 0 3px rgba(88,166,255,.18); background:#0b1220 }

  .btn-secondary{ background:#F0F6FC; color:#0D1117 }
  .btn-secondary:hover, .btn-secondary:focus{ background:#E6EDF3; color:#0D1117; transform:translateY(-2px); box-shadow:0 8px 20px rgba(88,166,255,.12) }

   /* –û—à–∏–±–∫–∞ */
  .toast{
  position:fixed;
  right:16px;
  bottom:16px;
  background:var(--error);
  padding:14px 18px;
  border-radius:10px;
  color:#fff;
  z-index:1000;
  animation:fadeIn .2s ease;
  }

</style>
</head>
<body class="bg-alt-3">
  <div id="bg-canvas"></div>
  <header>
    <div class="container header-bar">
      <a href="#" class="logo"><div class="logo-icon"></div>Speak2MD</a>
      <button id="btnOpenTranscripts" class="btn btn-ghost">–ú–æ–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã</button>

      <div id="headerAuth">
         <!-- –ï—Å–ª–∏ –ù–ï –∑–∞–ª–æ–≥–∏–Ω–µ–Ω ‚Üí –∫–Ω–æ–ø–∫–∏ -->
         <button id="btnLoginOpen" class="btn btn-primary">–í–æ–π—Ç–∏</button>
         <button id="btnRegisterOpen" class="btn btn-secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
      </div>
    </div>
  </header>

  <main class="container hero">
    <section class="glass-panel" aria-labelledby="title">
      <h1 id="title" class="title-main">–ò–∑ –≥–æ–ª–æ—Å–∞ –≤ Markdown.<br>–ë—ã—Å—Ç—Ä–æ. –¢–æ—á–Ω–æ.</h1>
      <p class="title-sub">–ó–∞–≥—Ä—É–∑–∏—Ç–µ –∞—É–¥–∏–æ –≤—Å—Ç—Ä–µ—á–∏ –∏–ª–∏ –ª–µ–∫—Ü–∏–∏. –ù–∞—à AI —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç —Ä–µ—á—å –∏ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç.</p>

      <!-- –û–±—ä–µ–¥–∏–Ω—ë–Ω–Ω–∞—è –∑–æ–Ω–∞: –∑–∞–≥—Ä—É–∑–∫–∞ + –∑–∞–ø–∏—Å—å -->
      <label id="mix" class="dropzone" tabindex="0" aria-label="–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ—Ñ–∞–π–ª –∏–ª–∏ –∑–∞–ø–∏—Å–∞—Ç—å">
        <input id="fileInput" type="file" accept=".mp3,.m4a,.wav,.webm,.ogg" />
        <div class="dz-icon"><svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="17 8 12 3 7 8"/><line x1="12" y1="3" x2="12" y2="15"/></svg></div>
        <div style="font-size:18px; font-weight:600; margin-bottom:4px; color:#fff">–ü–µ—Ä–µ—Ç–∞—â–∏—Ç–µ –∞—É–¥–∏–æ —Å—é–¥–∞</div>
        <div style="font-size:14px; color:var(--muted)">MP3, WAV, M4A (–¥–æ 50 –ú–ë)</div>
      </label>

      <div class="actions-row">
        <button id="btnUpload" class="btn btn-primary">–ó–∞–≥—Ä—É–∑–∏—Ç—å –∞—É–¥–∏–æ</button>
        <button id="btnRecord" class="btn btn-ghost" aria-pressed="false">
          <span id="recLabel">–ó–∞–ø–∏—Å—å</span>
          <span class="bars" aria-hidden="true"><i class="barv"></i><i class="barv"></i><i class="barv"></i><i class="barv"></i><i class="barv"></i></span>
        </button>
        <small id="recTimer" class="muted" aria-live="polite"></small>
      </div>

      <!-- –ü—Ä–æ–≥—Ä–µ—Å—Å -->
      <div id="statusBox" style="display:none; margin-top:16px">
        <div style="display:flex; justify-content:space-between; align-items:center; font-size:14px; margin-bottom:8px; color:var(--accent)">
          <strong id="statusText">–ê–Ω–∞–ª–∏–∑ –∞—É–¥–∏–æ...</strong>
          <span id="pct">0%</span>
        </div>
        <div class="progress-wrap"><div id="bar" class="progress-fill"></div></div>
        <button id="cancelBtn" class="btn btn-ghost" style="margin-top:8px">–û—Ç–º–µ–Ω–∏—Ç—å</button>
      </div>

      <!-- –†–µ–∑—É–ª—å—Ç–∞—Ç -->
      <div id="meta" class="meta" style="display:none">
        <span class="badge badge-ready">–ì–æ—Ç–æ–≤–æ</span>
        <div class="row">
          <a id="dlMd" class="btn btn-primary" download>–°–∫–∞—á–∞—Ç—å .md</a>
          <a id="dlJson" class="btn btn-ghost" download>JSON</a>
          <button class="btn btn-ghost" id="share-btn">üîó –ü–æ–¥–µ–ª–∏—Ç—å—Å—è</button>
        </div>
      </div>
      <pre id="preview" class="preview" aria-label="–ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä Markdown (—Å—ã—Ä–æ–π)"></pre>
      <div id="rendered" class="preview" aria-label="–†–µ–Ω–¥–µ—Ä Markdown (–∫—Ä–∞—Å–∏–≤—ã–π)" style="display:none"></div>
    </section>
  </main>

  

  <section class="container">
    <div class="features-grid">
      <div class="feature-card">
        <h3 style="color:#fff; margin-top:0">üéØ –¢–æ—á–Ω–æ—Å—Ç—å —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è</h3>
        <p style="color:var(--muted); font-size:14px; line-height:1.6">Whisper‚Äë–∫–ª–∞—Å—Å: —É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å –∫ —à—É–º—É, –∞–∫—Ü–µ–Ω—Ç–∞–º –∏ —Ä—É—Å/–∞–Ω–≥–ª —Ä–µ—á–∞–º.</p>
      </div>
      <div class="feature-card">
        <h3 style="color:#fff; margin-top:0">üóÇÔ∏è –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞–∑–º–µ—Ç–∫–∞</h3>
        <p style="color:var(--muted); font-size:14px; line-height:1.6">–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è, —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–∏–µ, –∏—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –æ—à–∏–±–æ–∫ –≤ —Ç–µ–∫—Å—Ç–µ.</p>
      </div>
      <div class="feature-card">
        <h3 style="color:#fff; margin-top:0">üìù –ì–æ—Ç–æ–≤—ã–π Markdown</h3>
        <p style="color:var(--muted); font-size:14px; line-height:1.6">–ó–∞–≥–æ–ª–æ–≤–∫–∏, —Å–ø–∏—Å–∫–∏, —Ç–∞–π–º–∫–æ–¥—ã; —ç–∫—Å–ø–æ—Ä—Ç –≤ .md –∏ JSON –¥–ª—è –¥–∞–ª—å–Ω–µ–π—à–µ–π —Ä–∞–±–æ—Ç—ã.</p>
      </div>
    </div>
  </section>
  <!-- –ú–æ–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã (–æ—Ç–¥–µ–ª—å–Ω–∞—è —Å–µ–∫—Ü–∏—è) -->
  <section id="transcriptsSec" class="container" style="display:none; position:relative; z-index:12">
    <div class="row" style="justify-content:space-between; align-items:center; margin-bottom:14px">
      <h2 style="margin:0">–ú–æ–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã</h2>
      <input id="transcriptsQ" placeholder="–ü–æ–∏—Å–∫" style="background:#0D1117;color:#C9D1D9;border:1px solid var(--border);border-radius:10px;padding:10px 12px;width:240px" />
    </div>
    <div id="transcriptsList" class="grid"></div>
    <div class="row" style="margin-top:16px">
      <button id="btnBackHome" class="btn btn-ghost">–ù–∞–∑–∞–¥</button>
    </div>
  </section>

  <footer class="container" style="text-align:center; padding:40px; color:rgba(255,255,255,0.2); font-size:13px">Designed for Speak2MD</footer>

<script>
addEventListener('pointermove', (e)=>{
  const x = (e.clientX / innerWidth * 100).toFixed(2) + '%';
  const y = (e.clientY / innerHeight * 100).toFixed(2) + '%';
  document.body.style.setProperty('--mx', x);
  document.body.style.setProperty('--my', y);
});

/* ====== –ï–¥–∏–Ω–∞—è –ø–∞–Ω–µ–ª—å: –∑–∞–≥—Ä—É–∑–∫–∞ ====== */
const dz = document.getElementById('mix');
 const fileInput = document.getElementById('fileInput');
 const pct = document.getElementById('pct');
const btnUpload = document.getElementById('btnUpload');

dz.addEventListener('dragover', e => { e.preventDefault(); dz.classList.add('active'); });
dz.addEventListener('dragleave', () => dz.classList.remove('active'));
dz.addEventListener('drop', e => {
  e.preventDefault(); dz.classList.remove('active');
  const f = e.dataTransfer.files?.[0]; if (f) startUpload(f);
});
dz.addEventListener('click', () => fileInput.click());
fileInput.addEventListener('change', e => {
  const f = e.target.files?.[0]; if (f) startUpload(f);
});
btnUpload.addEventListener('click', ()=> fileInput.click());

/* ====== –ó–∞–ø–∏—Å—å (–º–∏–Ω–∏–º—É–º –∫–æ–¥–∞, –º–∞–∫—Å–∏–º—É–º UX) ====== */
const btnRecord = document.getElementById('btnRecord');
const recLabel = document.getElementById('recLabel');
const recTimer = document.getElementById('recTimer');
let mediaRecorder, recChunks=[], recStart=0, recT;

btnRecord.addEventListener('click', async ()=>{
  if (!mediaRecorder || mediaRecorder.state==='inactive'){
    const stream = await navigator.mediaDevices.getUserMedia({audio:true});
    // –Ø–≤–Ω–æ –≤—ã–±–∏—Ä–∞–µ–º –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π MIME —Ç–∏–ø —Å —Ñ–æ–ª–±—ç–∫–∞–º–∏
    let preferred = 'audio/webm;codecs=opus';
    if (!window.MediaRecorder || !MediaRecorder.isTypeSupported(preferred)){
      preferred = MediaRecorder && MediaRecorder.isTypeSupported('audio/ogg;codecs=opus')
        ? 'audio/ogg;codecs=opus'
        : (MediaRecorder && MediaRecorder.isTypeSupported('audio/webm') ? 'audio/webm' : '');
    }
    mediaRecorder = preferred ? new MediaRecorder(stream, { mimeType: preferred }) : new MediaRecorder(stream);
    recChunks = [];
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) recChunks.push(e.data); };
    // Blob+–æ—Ç–ø—Ä–∞–≤–∫–∞ —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ –ø–æ–ª–Ω–æ–π –æ—Å—Ç–∞–Ω–æ–≤–∫–∏ (–≤–∫–ª—é—á–∞—è —Ñ–∏–Ω–∞–ª—å–Ω—ã–π —á–∞–Ω–∫)
    mediaRecorder.onstop = ()=> {
      clearInterval(recT); recTimer.textContent='';
      let type = mediaRecorder.mimeType || (recChunks[0] && recChunks[0].type) || '';
      if (!type) {
        const ua = (navigator.userAgent || '').toLowerCase();
        // –í Firefox —á–∞—â–µ –≤—Å–µ–≥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä OGG, –µ—Å–ª–∏ —Ç–∏–ø –Ω–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
        if (ua.includes('firefox')) type = 'audio/ogg;codecs=opus';
        else type = 'audio/webm;codecs=opus';
      }
      const blob = new Blob(recChunks, { type });
      // –≤—ã–±–µ—Ä–µ–º —Ä–∞—Å—à–∏—Ä–µ–Ω–∏–µ
      let ext = 'webm';
      const mt = String(blob.type || '').toLowerCase();
      if (mt.includes('ogg')) ext = 'ogg';
      else if (mt.includes('webm')) ext = 'webm';
      else if (mt.includes('wav')) ext = 'wav';
      else if (mt.includes('mp4')) ext = 'm4a';
      const file = new File([blob], `record.${ext}`, { type: blob.type });
      recChunks = [];
      startUpload(file);
    };
    mediaRecorder.start(); recStart = Date.now();
    btnRecord.setAttribute('aria-pressed','true'); recLabel.textContent='–ò–¥—ë—Ç –∑–∞–ø–∏—Å—å‚Ä¶';
    recT = setInterval(()=>{
      const s = Math.floor((Date.now()-recStart)/1000);
      recTimer.textContent = String(Math.floor(s/60)).padStart(2,'0') + ':' + String(s%60).padStart(2,'0');
    }, 500);
  }else{
    mediaRecorder.stop();
    btnRecord.setAttribute('aria-pressed','false'); recLabel.textContent='–ó–∞–ø–∏—Å—å';
  }
});

/* ====== –ü—Ä–æ–≥—Ä–µ—Å—Å/—Ä–µ–∑—É–ª—å—Ç–∞—Ç ====== */
const statusBox = document.getElementById('statusBox');
const statusText = document.getElementById('statusText');
const bar = document.getElementById('bar');
const cancelBtn = document.getElementById('cancelBtn');
const meta = document.getElementById('meta');
const preview = document.getElementById('preview');
const dlMd = document.getElementById('dlMd');
const dlJson = document.getElementById('dlJson');
let jobId=null, ws=null, poll=null;

async function startUpload(file){
  if (!/\.(mp3|m4a|wav)$/i.test(file.name) && !/webm|ogg/i.test(file.type)){
    alert('–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é—Ç—Å—è mp3/m4a/wav (–∑–∞–ø–∏—Å—å ‚Äî webm/ogg)'); return; /* FR-001 */
  }
  if (file.size > 50*1024*1024){ alert('–§–∞–π–ª –±–æ–ª—å—à–µ 50‚ÄØ–ú–ë'); return; } /* FR-002 */

  const fd = new FormData(); fd.append('file', file);
  const res = await auth.fetchWithAuth('/api/upload', {method:'POST', body:fd});
  if(!res.ok){ alert('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'); return; }
  const data = await res.json(); jobId = data.job_id;

  statusBox.style.display=''; meta.style.display='none'; preview.style.display='none';
  bar.style.width='0%'; statusText.innerHTML='<strong>–û–±—Ä–∞–±–æ—Ç–∫–∞‚Ä¶</strong> (VAD ‚Üí ASR ‚Üí –†–∞–∑–º–µ—Ç–∫–∞)';
  if(pct) pct.textContent = '0%';

  connectWS(jobId);
}
cancelBtn.addEventListener('click', ()=>{ try{ if(ws && typeof ws.close==='function') ws.close(); }catch(e){} if(poll){ clearInterval(poll); poll=null; } statusText.textContent='–û—Ç–º–µ–Ω–µ–Ω–æ'; });

function handleProgress(p){
  if (typeof p.progress==='number'){
    const v = Math.max(0, Math.min(100, p.progress));
    bar.style.width = v + '%';
    if(pct) pct.textContent = String(Math.round(v)) + '%';
  }
  if (p.status==='ready'){ try{ if(ws && typeof ws.close==='function') ws.close(); }catch(e){} if(poll){ clearInterval(poll); poll=null; } loadResult(); }
  if (p.status==='error'){ try{ if(ws && typeof ws.close==='function') ws.close(); }catch(e){} if(poll){ clearInterval(poll); poll=null; } statusText.textContent='–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏'; }
  if (p.message){ statusText.textContent = p.message; }
}

function startPolling(jobId){
  if(poll) return;
  poll = setInterval(async ()=>{
    try{
      const r = await fetch(`/api/status/${jobId}`);
      if(r.ok){ const p = await r.json(); handleProgress(p); }
    }catch{}
  }, 1200);
}

function connectWS(jobId){
  const proto = location.protocol === 'https:' ? 'wss' : 'ws';
  try{
    ws = new WebSocket(`${proto}://${location.host}/api/ws/${jobId}`);
    ws.onmessage = (e)=>{
      try{
        const msg = JSON.parse(e.data);
        if (msg && msg.event === 'progress' && msg.data){ handleProgress(msg.data); }
      }catch{}
    };
    ws.onclose = ()=>{ startPolling(jobId); };
    ws.onerror = ()=>{ try{ ws.close(); }catch{} startPolling(jobId); };
  }catch{ startPolling(jobId); }
}

async function loadResult(){
  statusText.textContent='–ì–æ—Ç–æ–≤–æ';
  const md = await fetch(`/api/result/${jobId}?format=markdown`).then(r=>r.text());
  // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å—ã—Ä–æ–π Markdown, –Ω–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∫—Ä–∞—Å–∏–≤—ã–π —Ä–µ–Ω–¥–µ—Ä.
  preview.textContent = md;
  const rendered = document.getElementById('rendered');
  if(window.marked && rendered){
    rendered.innerHTML = window.marked.parse(md);
    rendered.style.display='block';
    preview.style.display='none';
  } else {
    // –§–æ–ª–±—ç–∫: –µ—Å–ª–∏ marked –Ω–µ –∑–∞–≥—Ä—É–∑–∏–ª—Å—è ‚Äî –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—ã—Ä–æ–π Markdown
    preview.style.display='block';
  }
  if(pct) pct.textContent = '100%';
  meta.style.display='flex';
  dlMd.href = `/api/result/${jobId}?format=markdown`;
  dlJson.href = `/api/result/${jobId}?format=json`;
}

const shareBtn = document.getElementById('share-btn');
if(shareBtn){
  shareBtn.onclick = async ()=>{
    if(!jobId) return;
    try{
      const r = await auth.fetchWithAuth('/api/share/' + jobId, { method:'POST' });
      if(!r.ok){ return showError('–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å —Å—Å—ã–ª–∫—É'); }
      const data = await r.json();
      const full = data && data.url ? (data.url.startsWith('http') ? data.url : (location.origin + data.url)) : '';
      const inp = document.getElementById('shareUrlInput'); if(inp){ inp.value = full; }
      const exp = document.getElementById('shareExpires'); if(exp){ exp.textContent = data.expires_at ? ('–î–æ—Å—Ç—É–ø –¥–æ: ' + new Date(data.expires_at).toLocaleString('ru-RU')) : ''; }
      try{ const tok = String((data.url||'').split('/').pop()||''); const open = document.getElementById('btnShareOpen'); if(open && tok){ const vu = location.origin + '/share/' + tok; open.href = vu; if(inp){ inp.value = vu; } } }catch{}
      showModal('modalShare');
    }catch{ showError('—Å–µ—Ç–µ–≤–æ–π —É–ª–µ—Ç–µ–ª'); }
  };
}

 

/* ====== –ú–µ–ª–∫–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞: –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞ –¥–ª—è dropzone ====== */
dz.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); fileInput.click(); }});

/* –û—Ç–∫—Ä—ã—Ç–∏–µ/–ó–∞–∫—Ä—ã—Ç–∏–µ –º–æ–¥–∞–ª–æ–∫ */
function showModal(id){
  document.getElementById(id).classList.remove("hidden");
  if(id === "modalRegister"){ const b = document.getElementById("btnRegisterSubmit"); if(b) b.onclick = doRegister; }
  if(id === "modalLogin"){ const b = document.getElementById("btnLoginSubmit"); if(b) b.onclick = doLogin; }
  if(id === "modalShare"){ const b = document.getElementById("btnShareCopy"); if(b) b.onclick = async ()=>{ const val = (document.getElementById('shareUrlInput')||{}).value || ''; try{ await navigator.clipboard.writeText(val); showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); } catch{ try{ const i = document.getElementById('shareUrlInput'); if(i){ i.select(); document.execCommand('copy'); showSuccess('–°—Å—ã–ª–∫–∞ —Å–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–∞'); } } catch{ showError('–Ω–µ —É–¥–∞–ª–æ—Å—å —Å–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å'); } } }; }
}

function hideModal(id){
  document.getElementById(id).classList.add("hidden");
}

document.getElementById("btnLoginOpen").onclick = () => showModal("modalLogin");
document.getElementById("btnRegisterOpen").onclick = () => showModal("modalRegister");
{ const b = document.getElementById("btnOpenTranscripts"); if(b) b.onclick = () => showTranscripts(); }

/* –û—à–∏–±–∫–∞ */
function showError(msg){
  const t = document.createElement("div");
  t.className = "toast";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 3000);
}

function showSuccess(msg){
  const t = document.createElement("div");
  t.className = "toast";
  t.style.background = "var(--success)";
  t.textContent = msg;
  document.body.appendChild(t);
  setTimeout(()=> t.remove(), 3000);
}

//auth‚Äë–∫–ª–∏–µ–Ω—Ç: —Ö—Ä–∞–Ω–µ–Ω–∏–µ —Ç–æ–∫–µ–Ω–æ–≤ + refresh
const auth = (function(){
  let accessToken = null;
  let refreshToken = null;
  function load(){
    accessToken = localStorage.getItem('s2md_access') || null; // –Ω—É —Ç–∏–ø —á–∏—Ç–∞–µ–º
    refreshToken = localStorage.getItem('s2md_refresh') || null;
  }
  function save(a,r){
    accessToken = a || null;
    refreshToken = r || null;
    try{ localStorage.setItem('s2md_access', a || ''); localStorage.setItem('s2md_refresh', r || ''); }catch{}
  }
  async function fetchWithAuth(url, options){
    const opts = Object.assign({}, options||{});
    opts.headers = opts.headers || {};
    if(accessToken){ opts.headers['Authorization'] = 'Bearer ' + accessToken; }
    let res = await fetch(url, opts);
    if(res.status === 401 && refreshToken){
      const r = await fetch('/api/auth/refresh', { method:'POST', headers:{ 'Content-Type':'application/json' }, body: JSON.stringify({ refresh_token: refreshToken }) });
      if(r.ok){ const data = await r.json(); save(data.access_token, data.refresh_token); opts.headers['Authorization'] = 'Bearer ' + (data.access_token||''); res = await fetch(url, opts); }
    }
    return res;
  }
  function clear(){
    accessToken = null; refreshToken = null;
    try{ localStorage.removeItem('s2md_access'); localStorage.removeItem('s2md_refresh'); localStorage.removeItem('s2md_user'); }catch{}
  }
  load();
  return { save, fetchWithAuth, clear };
})();

/*–ñ–í–¢-—Ö—Ä–∞–Ω–∏–ª–∏—â–µ*/
function saveTokens(tokens){
  try{
    localStorage.setItem('s2md_access', tokens.access_token || '');
    localStorage.setItem('s2md_refresh', tokens.refresh_token || '');
  }catch{}
}

async function fetchAndSaveUser(){
  const acc = localStorage.getItem('s2md_access') || '';
  if(!acc) return;
  try{
    const r = await auth.fetchWithAuth('/api/me');
    if(r.ok){ const u = await r.json(); try{ localStorage.setItem('s2md_user', JSON.stringify(u)); }catch{} }
  }catch{}
}

function getUser(){
  try{ return JSON.parse(localStorage.getItem('s2md_user')||'null'); }catch{ return null }
}

function confetti(){
  const c = document.createElement('div');
  c.style.position = 'fixed';
  c.style.left = '0';
  c.style.top = '0';
  c.style.pointerEvents = 'none';
  c.style.zIndex = '1000';
  c.style.width = '100%';
  c.style.height = '100%';
  document.body.appendChild(c);
  const colors = ['#58A6FF','#3FB950','#F85149','#FFD33D','#B887FF'];
  const count = 80;
  for(let i=0;i<count;i++){
    const p = document.createElement('div');
    p.style.position = 'absolute';
    p.style.width = '8px';
    p.style.height = '14px';
    p.style.background = colors[Math.floor(Math.random()*colors.length)];
    p.style.left = (Math.random()*innerWidth) + 'px';
    p.style.top = '-20px';
    p.style.opacity = '1';
    p.style.transform = 'translateY(0) rotate(0deg)';
    p.style.borderRadius = '3px';
    p.style.transition = 'transform 1.6s ease, opacity 1.6s ease';
    c.appendChild(p);
    const dx = (Math.random()-0.5)*160;
    const dy = innerHeight + Math.random()*200;
    const rot = Math.random()*720;
    setTimeout(()=>{ p.style.transform = `translate(${dx}px, ${dy}px) rotate(${rot}deg)`; p.style.opacity = '0'; }, 20);
  }
  setTimeout(()=>{ c.remove(); }, 1800);
}

/* –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è */
async function doRegister(){
  const username = document.getElementById("regUsername").value.trim();
  const password = document.getElementById("regPassword").value;
  const full_name = document.getElementById("regFullname").value.trim();
  if(!username) return showError("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω");
  if((password||"").length < 8) return showError("–ü–∞—Ä–æ–ª—å –Ω–µ –º–µ–Ω–µ–µ 8 —Å–∏–º–≤–æ–ª–æ–≤");
  const payload = { username, password, full_name };

  const r = await fetch("/api/auth/register", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(payload)
  });

  if (r.status === 400){
    let msg = "–û—à–∏–±–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏";
    try{ const e = await r.json(); msg = e?.error || msg; }catch{}
    return showError(msg);
  }

  if (!r.ok) return showError("–°–µ—Ä–≤–µ—Ä –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω");
  // —É—Å–ø–µ—à–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è ‚Üí —Å—Ä–∞–∑—É –ª–æ–≥–∏–Ω –ø–æ —Ç–µ–º –∂–µ –¥–∞–Ω–Ω—ã–º
  const lr = await fetch("/api/auth/login", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ username: payload.username, password: payload.password })
  });
  if (!lr.ok) return showError("–õ–æ–≥–∏–Ω –ø–æ—Å–ª–µ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –Ω–µ –ø—Ä–æ—à—ë–ª");
  const tokens = await lr.json();
  auth.save(tokens.access_token, tokens.refresh_token);
  await fetchAndSaveUser();
  hideModal("modalRegister");
  updateHeaderAuth();
  showSuccess("–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è —É—Å–ø–µ—à–Ω–∞");
  confetti();
}

/* –í—Ö–æ–¥ */
async function doLogin(){
  const username = document.getElementById("loginUsername").value.trim();
  const password = document.getElementById("loginPassword").value;
  if(!username) return showError("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω");
  if(!password) return showError("–í–≤–µ–¥–∏—Ç–µ –ø–∞—Ä–æ–ª—å");
  const payload = { username, password };

  const r = await fetch("/api/auth/login", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body: JSON.stringify(payload)
  });

  if (r.status === 401) return showError("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
  if (!r.ok) return showError("–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞");
  const data = await r.json();
  auth.save(data.access_token, data.refresh_token);
  await fetchAndSaveUser();

  hideModal("modalLogin");
  updateHeaderAuth();
}

/* –°–º–µ–Ω–∞ —Å–æ—Å—Ç–æ—è–Ω–∏—è —Ö–µ–¥–µ—Ä–∞ (¬´–≥–æ—Å—Ç—å ‚Üî –∑–∞–ª–æ–≥–∏–Ω–µ–Ω¬ª) */
function updateHeaderAuth(){
  const box = document.getElementById("headerAuth");
  const user = getUser(); 

  if (!user){
    box.innerHTML = `
      <button id="btnLoginOpen" class="btn btn-primary">–í–æ–π—Ç–∏</button>
      <button id="btnRegisterOpen" class="btn btn-secondary">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    `;
    document.getElementById("btnLoginOpen").onclick = () => showModal("modalLogin");
    document.getElementById("btnRegisterOpen").onclick = () => showModal("modalRegister");
    return;
  }

  box.innerHTML = `
    <span>${user.username || 'user'}</span>
    <span class="badge badge-${user.plan || 'free'}">${user.plan || 'free'}</span>
    <button id="btnLogout" class="btn btn-ghost" style="padding:6px 8px; opacity:.8">–í—ã–π—Ç–∏</button>
  `;
  const bl = document.getElementById('btnLogout');
  if(bl){ bl.onclick = ()=>{ auth.clear(); const sec=document.getElementById('transcriptsSec'); if(sec) sec.style.display='none'; const hero=document.querySelector('main.container.hero'); if(hero) hero.style.display='block'; updateHeaderAuth(); showSuccess('–í—ã –≤—ã—à–ª–∏'); }; }
}

// –æ—Ç–∫—Ä—ã—Ç—å —Å–µ–∫—Ü–∏—é ¬´–º–æ–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã¬ª 
function showTranscripts(){
  const sec = document.getElementById('transcriptsSec');
  if(!sec) return;
  sec.style.display = 'block';
  const hero = document.querySelector('main.container.hero');
  if(hero) hero.style.display = 'none';
  loadTranscripts('');
  const q = document.getElementById('transcriptsQ'); if(q){ q.focus(); /* –Ω—É —á—Ç–æ–± —Å—Ä–∞–∑—É –ø–µ—á–∞—Ç–∞—Ç—å */ }
}

// –æ—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –∫–∞—Ä—Ç–æ—á–∫–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–æ–≤ (–ø—Ä–æ—Å—Ç—ã–µ .card)
function renderTranscripts(items){
  const box = document.getElementById('transcriptsList');
  if(!box) return;
  box.innerHTML = '';
  for(const it of (items||[])){
    const card = document.createElement('div');
    card.className = 'card';
    card.style.cursor = 'pointer';
    const title = String(it.title||'–ë–µ–∑ –Ω–∞–∑–≤–∞–Ω–∏—è');
    const dt = it.created_at ? new Date(it.created_at) : null;
    const dd = dt ? dt.toLocaleString('ru-RU') : '';
    const mins = typeof it.duration_sec === 'number' ? Math.floor(it.duration_sec/60) : 0;
    card.innerHTML = `
      <div style="display:flex; justify-content:space-between; align-items:center">
        <strong>${title}</strong>
        <div class="row" style="gap:8px">
          <span class="badge badge-ready">${(it.status||'ready')}</span>
          <button class="btn btn-ghost" style="padding:8px 10px">–£–¥–∞–ª–∏—Ç—å</button>
        </div>
      </div>
      <div class="muted" style="font-size:13px">${dd}</div>
      <div class="muted" style="font-size:13px">–¥–ª–∏–Ω–∞: ${mins} –º–∏–Ω</div>
    `;
    card.onclick = ()=> openTranscript(it.id, title);
    const delBtn = card.querySelector('button.btn.btn-ghost');
    if(delBtn){ delBtn.onclick = (e)=>{ e.stopPropagation(); deleteTranscript(it.id); }; }
    box.appendChild(card);
  }
}

//–≥—Ä—É–∑–∏–º –º–æ–∏ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç—ã ( —Ç–∏–ø —Å–ø–∏—Å–æ–∫)
async function loadTranscripts(q=''){
  try{
    const res = await auth.fetchWithAuth('/api/transcripts?limit=50&offset=0');
    if(!res.ok){ if(res.status===401) return showError('–ù—É–∂–Ω–æ –≤–æ–π—Ç–∏'); return showError('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å'); }
    const data = await res.json();
    const items = Array.isArray(data.items) ? data.items : [];
    const ql = String(q||'').toLowerCase();
    const filtered = ql ? items.filter(it => String(it.title||'').toLowerCase().includes(ql)) : items;
    renderTranscripts(filtered);
  }catch{ showError('—Å–µ—Ç–µ–≤–æ–π —É–ª–µ—Ç–µ–ª'); }
}

// –æ—Ç–∫—Ä—ã—Ç—å –æ–¥–Ω—É –∑–∞–ø–∏—Å—å ‚Üí –º–æ–¥–∞–ª–∫–∞ —Å Markdown (–∫—Ä–∞—Å–∏–≤–æ–æ–æ)
async function openTranscript(id, title){
  try{
    const r = await auth.fetchWithAuth(`/api/transcripts/${id}?format=markdown`);
    if(!r.ok){ return showError('–Ω–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–∫—Ä—ã—Ç—å'); }
    const md = await r.text();
    const t = document.getElementById('trTitle'); if(t) t.textContent = title || ('Transcript '+id);
    const c = document.getElementById('trContent');
    if(c){ c.innerHTML = (window.marked && window.marked.parse) ? window.marked.parse(md) : md; }
    showModal('modalTranscript');
  }catch{ showError('—Å–µ—Ç–µ–≤–æ–π —É–ª–µ—Ç–µ–ª'); }
}

// —É–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å (—Å–ø—Ä–æ—Å–∏–º –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏)
async function deleteTranscript(id){
  if(!id) return;
  if(!confirm('–¢–æ—á–Ω–æ —É–¥–∞–ª–∏—Ç—å?')) return;
  try{
    const r = await auth.fetchWithAuth(`/api/transcripts/${id}`, { method:'DELETE' });
    if(!r.ok){ return showError('–Ω–µ —É–¥–∞–ª–∏–ª–æ—Å—å'); }
    showSuccess('–£–¥–∞–ª–µ–Ω–æ');
    const q = document.getElementById('transcriptsQ');
    const val = q ? String(q.value||'').trim() : '';
    await loadTranscripts(val);
  }catch{ showError('—Å–µ—Ç–µ–≤–æ–π —É–ª–µ—Ç–µ–ª'); }
}

// –ø–æ–∏—Å–∫ –∏ ¬´–Ω–∞–∑–∞–¥¬ª
document.addEventListener('DOMContentLoaded', async ()=>{
  const q = document.getElementById('transcriptsQ');
  if(q){ q.addEventListener('input', (e)=> loadTranscripts(String(e.target.value||'').trim())); }
  const back = document.getElementById('btnBackHome');
  if(back){ back.onclick = ()=>{ const sec=document.getElementById('transcriptsSec'); if(sec) sec.style.display='none'; const hero=document.querySelector('main.container.hero'); if(hero) hero.style.display='block'; } };
  try{ await fetchAndSaveUser(); }catch{}
  updateHeaderAuth(); //–≤–æ—Å—Å—Ç–∞–Ω–æ–≤–∏–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
  
});

// p5.js trailing grid implementation will be loaded below
</script>
<!-- p5.js CDN -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.9.0/p5.min.js"></script>

<!-- Markdown render (marked) -->
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

<!-- –º–æ–¥–∞–ª–∫–∞ –ø—Ä–æ—Å–º–æ—Ç—Ä–∞ —Ç—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç–∞ -->
<div id="modalTranscript" class="modal hidden">
  <div class="modal-box" style="width:640px; max-height:70vh; overflow:auto">
    <h3 id="trTitle">–¢—Ä–∞–Ω—Å–∫—Ä–∏–ø—Ç</h3>
    <div id="trContent" class="preview" style="display:block"></div>
    <button class="btn btn-ghost" onclick="hideModal('modalTranscript')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<script>
const sketch = (p) => {
  let particles = [];
  const density = 150;

  p.setup = () => {
    const c = p.createCanvas(p.windowWidth, p.windowHeight);
    c.parent('bg-canvas');
    for(let i = 0; i < (p.width * p.height) / 12000; i++){
      particles.push(new Particle(p));
    }
  };

  p.windowResized = () => { p.resizeCanvas(p.windowWidth, p.windowHeight); };

  p.draw = () => {
    p.clear();
    for(let i = 0; i < particles.length; i++){
      const p1 = particles[i];
      p1.update();
      p1.draw();
      const dMouse = p.dist(p.mouseX, p.mouseY, p1.pos.x, p1.pos.y);
      if(dMouse < 250){
        p1.pos.x += (p.mouseX - p1.pos.x) * 0.005;
        p1.pos.y += (p.mouseY - p1.pos.y) * 0.005;
      }
      for(let j = i; j < particles.length; j++){
        const p2 = particles[j];
        const d = p.dist(p1.pos.x, p1.pos.y, p2.pos.x, p2.pos.y);
        if(d < 120){
          const alpha = p.map(d, 0, 120, 150, 0);
          p.stroke(100, 200, 255, alpha * 0.3);
          p.strokeWeight(1);
          p.line(p1.pos.x, p1.pos.y, p2.pos.x, p2.pos.y);
        }
      }
    }
  };

  class Particle {
    constructor(p){
      this.p = p;
      this.pos = p.createVector(Math.random() * p.width, Math.random() * p.height);
      this.vel = p.createVector((Math.random()-0.5)*0.5, (Math.random()-0.5)*0.5);
      this.size = Math.random() * 2;
    }
    update(){
      this.pos.add(this.vel);
      if(this.pos.x < 0 || this.pos.x > this.p.width) this.vel.x *= -1;
      if(this.pos.y < 0 || this.pos.y > this.p.height) this.vel.y *= -1;
    }
    draw(){
      this.p.noStroke();
      this.p.fill(200, 230, 255, 150);
      this.p.circle(this.pos.x, this.pos.y, this.size);
    }
  }
};
new p5(sketch);
</script>
<!-- –º–æ–¥–∞–ª–∫–∞ –≤—Ö–æ–¥–∞ -->
<div id="modalLogin" class="modal hidden">
  <div class="modal-box">
    <h3>–í—Ö–æ–¥</h3>
    <input id="loginUsername" type="text" placeholder="–õ–æ–≥–∏–Ω">
    <input id="loginPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="btnLoginSubmit" class="btn btn-primary">–í–æ–π—Ç–∏</button>
    <button class="btn btn-ghost" onclick="hideModal('modalLogin')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<!-- –º–æ–¥–∞–ª–∫–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ -->
<div id="modalRegister" class="modal hidden">
  <div class="modal-box">
    <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
    <input id="regUsername" type="text" placeholder="–õ–æ–≥–∏–Ω">
    <input id="regFullname" type="text" placeholder="–ò–º—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)">
    <input id="regPassword" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
    <button id="btnRegisterSubmit" class="btn btn-primary">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
    <button class="btn btn-ghost" onclick="hideModal('modalRegister')">–ó–∞–∫—Ä—ã—Ç—å</button>
  </div>
</div>

<div id="modalShare" class="modal hidden">
  <div class="modal-box">
    <h3>–ü–æ–¥–µ–ª–∏—Ç—å—Å—è</h3>
    <input id="shareUrlInput" type="text" readonly placeholder="–°—Å—ã–ª–∫–∞">
    <div id="shareExpires" class="muted" style="font-size:13px"></div>
    <div class="row" style="justify-content:flex-end">
      <a id="btnShareOpen" class="btn btn-ghost" target="_blank">–û—Ç–∫—Ä—ã—Ç—å</a>
      <button id="btnShareCopy" class="btn btn-primary">–°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
      <button class="btn btn-ghost" onclick="hideModal('modalShare')">–ó–∞–∫—Ä—ã—Ç—å</button>
    </div>
  </div>
</div>

</body>
</html>
